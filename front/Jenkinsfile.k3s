pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
    }

    environment {
        // âœ… í™˜ê²½ ë³€ìˆ˜ ì •ì˜
        DOCKERHUB_CREDENTIALS = credentials('seung-dockerhub-credentials')  // ì  í‚¨ìŠ¤ì— ë“±ë¡ëœ DockerHub ID/PW
        DOCKER_IMAGE = "seung0208/front"
        DEPLOY_USER = "ubuntu"
        DEPLOY_SERVER = "13.124.109.82"       // EC2 ì„œë²„ IP (k3s ë§ˆìŠ¤í„°)
        DEPLOY_PATH = "/home/ubuntu/k3s-deploy" // kubectl apply ì‹¤í–‰ ê²½ë¡œ
        K8S_DIR = "k8s"
    }

    stages {
        stage('Checkout') {
            steps {
                echo " GitHubì—ì„œ ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
                checkout scm
                sh '''
                  echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
                  echo "Commit: $(git rev-parse --short HEAD)"
                  echo "Commit message: $(git log -1 --pretty=%B)"
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                echo " ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                sh '''
                docker build -t ${DOCKER_IMAGE}:latest .
                '''
            }
        }

        stage('Login & Push Docker Image') {
            steps {
                echo " DockerHub ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ í‘¸ì‹œ"
                sh '''
                echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u seung0208 --password-stdin
                docker push ${DOCKER_IMAGE}:latest
                '''
            }
        }

        stage('Sync YAML to Server') {
            steps {
                echo "ğŸ—‚ï¸ k3s-front.yaml ìµœì‹  ë²„ì „ì„ ì„œë²„ë¡œ ë™ê¸°í™” (ë®ì–´ì“°ê¸° ë˜ëŠ” ì‹ ê·œ ìƒì„±)"
                script {
                    sshagent(credentials: ['healthyreal-main']) {
                        // ì„œë²„ì— yaml í´ë”ê°€ ì—†ìœ¼ë©´ ë§Œë“¤ê³ , yaml íŒŒì¼ ë®ì–´ì“°ê¸°
                        sh """
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} '
                            mkdir -p ${DEPLOY_PATH}
                        '
                        scp -o StrictHostKeyChecking=no ${K8S_DIR}/k3s-front.yaml ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/k3s-front.yaml
                        """
                    }
                }
            }
        }

        stage('Deploy to k3s Cluster') {
            steps {
                echo " ì›ê²© ì„œë²„ì— ë°°í¬(kubectl apply -f)"
                script {
                    sshagent(credentials: ['healthyreal-main']) {
                        
                        // kubectl set image <ë¦¬ì†ŒìŠ¤ì¢…ë¥˜>/<ë¦¬ì†ŒìŠ¤ì´ë¦„> <deployment ë‚´ë¶€ì— ì •ì˜í•œ ì»¨í…Œì´ë„ˆì´ë¦„>=<ìƒˆì´ë¯¸ì§€> [ì˜µì…˜]
                        sh """
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} '
                            echo "ğŸ”„ ìµœì‹  Docker ì´ë¯¸ì§€ Pull..."
                            
                            # ë°°í¬ ì‹¤í–‰
                            sudo k3s kubectl apply -f ${DEPLOY_PATH}/k3s-front.yaml
                            kubectl rollout restart deployment front &&
                            kubectl rollout status deployment front

                            echo "âœ… ë°°í¬ ì™„ë£Œ"
                        '
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Front ë°°í¬ ì„±ê³µ!"
        }
        failure {
            echo " ë°°í¬ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}
