name: Auto PR from develop to main (monorepo)

on:
  push:
    branches:
      - develop
    paths:
      - "front/**"
      - "back/**"
      - "flask/**"
      - "infra_db/**"
      - ".github/**"

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write   # ✅ 라벨 생성/부착은 issues 권한이 필요함

    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed areas
        id: changes
        shell: bash
        run: |
          set -e
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"

          if [[ "$BASE" == "0000000000000000000000000000000000000000" ]]; then
            BASE="$(git rev-parse HEAD^)"
          fi

          files="$(git diff --name-only "$BASE" "$HEAD")"
          echo "Changed files:"
          echo "$files"

          front=false
          back=false
          flask=false
          infra_db=false
          workflow=false

          while IFS= read -r f; do
            [[ "$f" == front/* ]] && front=true
            [[ "$f" == back/* ]] && back=true
            [[ "$f" == flask/* ]] && flask=true
            [[ "$f" == infra_db/* ]] && infra_db=true
            [[ "$f" == .github/* ]] && workflow=true
          done <<< "$files"

          echo "front=$front" >> "$GITHUB_OUTPUT"
          echo "back=$back" >> "$GITHUB_OUTPUT"
          echo "flask=$flask" >> "$GITHUB_OUTPUT"
          echo "infra_db=$infra_db" >> "$GITHUB_OUTPUT"   # ✅ key 하이픈 제거 권장
          echo "workflow=$workflow" >> "$GITHUB_OUTPUT"

          labels=()
          $front && labels+=("front")
          $back && labels+=("back")
          $flask && labels+=("flask")
          $infra_db && labels+=("infra_db")
          $workflow && labels+=("workflow")

          if [[ ${#labels[@]} -eq 0 ]]; then
            echo "should_create=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_create=true" >> "$GITHUB_OUTPUT"

            summary=""
            $front && summary="${summary}- front 변경\n"
            $back && summary="${summary}- back 변경\n"
            $flask && summary="${summary}- flask 변경\n"
            $infra_db && summary="${summary}- infra_db 변경\n"
            $workflow && summary="${summary}- .github 변경\n"

            echo "summary<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$summary" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"

            # ✅ JSON을 반드시 한 줄로 만들기(-c)
            json="$(printf '%s\n' "${labels[@]}" | jq -R . | jq -s -c .)"
            echo "labels=$json" >> "$GITHUB_OUTPUT"
          fi


      - name: Create PR + Add Labels
        if: steps.changes.outputs.should_create == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_PR_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const head = context.ref.replace('refs/heads/', ''); // develop
            const base = 'main';

            // 기존 PR 있는지 확인
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${head}`,
              base,
            });

            if (pulls.length > 0) {
              core.info(`Existing PR #${pulls[0].number} found. Skipping creation.`);
              return;
            }

            const summary = `${{ toJSON(steps.changes.outputs.summary) }}`.replace(/^"|"$/g, '');
            const labels = JSON.parse(`${{ steps.changes.outputs.labels }}`);

            const body = [
              '변경 사항을 검토 후 merge 해주세요!',
              '',
              '### 변경 범위(모노레포)',
              summary,
            ].join('\n');

            // PR 생성
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title: `Auto PR: develop → main`,
              body,
            });

            const prNumber = pr.data.number;
            core.info(`Created PR #${prNumber}: ${pr.data.html_url}`);

            // ✅ 라벨이 없으면 생성(선택이지만 안정적)
            // GitHub 라벨은 색상이 필요함(6자리 hex, # 제외)
            const labelColors = {
              front: "1f6feb",
              back: "238636",
              flask: "a371f7",
              infra_db: "f85149",
              workflow: "cccccc",
            };

            for (const name of labels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                // 404면 생성
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner,
                    repo,
                    name,
                    color: labelColors[name] || "cccccc",
                    description: `Changes in ${name}`,
                  });
                  core.info(`Created label: ${name}`);
                } else {
                  throw e;
                }
              }
            }

            // ✅ PR(=issue)에 라벨 부착
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels,
            });

            core.info(`Added labels to PR #${prNumber}: ${labels.join(', ')}`);
